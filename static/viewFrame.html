<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speakeasy</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 50px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin-top: 20px;
        }
        select {
            padding: 10px;
            font-size: 16px;
        }
        #translationSection {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Speakeasy</h1>
    <div id="controls">
        <button class="start">Start</button>
        <br><br>
        <label for="options">Choose a language:</label>
        <select id="options">
            <option value="French">French</option>
            <option value="Arabic">Arabic</option>
            <option value="Piglatin">Piglatin</option>
        </select>
    </div>

    <div id="translationSection">
        <p id="feedbackText"></p>
        <p id="instructionText">Say the word in the selected language</p>
        <p id="wordToTranslate">test</p>
        <button class="startRecord">Start Record</button>
        <button class="stopRecord">Stop Record</button>
        <br><br>
        <button class="back">Back</button>
    </div>

    <script>
        let analyser;  // Global analyser
        let audioLevelsData;  // Global audioLevelsData

        function startLesson() {
            const selectedLanguage = document.getElementById("options").value;
            const wordToTranslate = document.getElementById("wordToTranslate");

            fetch('/start-lesson', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ language: selectedLanguage })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById("controls").style.display = "none";
                document.getElementById("translationSection").style.display = "block";
                instructionText.innerText = "Say the word in the selected language";

                startEventSource();  // Start listening for updates 
            })
            .catch(error => console.error('Error:', error));
        }

        function startEventSource() {
            const eventSource = new EventSource('/wordStream');

            eventSource.onmessage = function(event) {
                console.log("Received word:", event.data);

                if (event.data.startsWith("Correct!") || event.data.startsWith("Incorrect!")) {
                    feedbackText.innerText = event.data;
                } else {
                    wordToTranslate.innerText = event.data;
                    wordToTranslate.style.visibility = "visible";
                }
                
            };

            eventSource.onerror = function() {
                console.error("EventSource failed.");
                eventSource.close();
            };
        }

        function setWord(){
            fetch('/get_string')
            .then(response => response.json())
            .then(data => {
                document.getElementById('wordToTranslate').innerText = data.data;
            })
            .catch(error => console.error('Error:', error));
        }

        function stopLesson() {
            fetch('/stop-lesson', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .catch(error => console.error('Error:', error));
        }

        function updateAudioLevels() {
            console.log("Updating Audio Levels");
            if (analyser) {
                analyser.getFloatFrequencyData(audioLevelsData);  // Get audio levels
                console.log("Audio Levels:", audioLevelsData);
            } else {
                console.error("Analyser is not initialized");
            }
        }

        function startRecording(mediaRecorder, recordButton) {
            mediaRecorder.start();
            console.log("recorder started");
            recordButton.style.background = "red";
            recordButton.style.color = "black";

            setInterval(updateAudioLevels, 1000);
        }

        function stopRecording(mediaRecorder, recordButton) {
            wordToTranslate.style.visibility = "hidden";
            mediaRecorder.stop();
            console.log(mediaRecorder.state);
            console.log("recorder stopped");
            recordButton.style.background = "lightGrey";
            document.getElementById("feedbackText").innerText = "Processing...";
        }

        function handleStop(chunks) {
            const blob = new Blob(chunks, { type: 'audio/webm' });
            const file = new File([blob], "userAudio.webm", { type: 'audio/webm' });

            const formData = new FormData();
            formData.append('audio_file', file);

            fetch('/upload-audio', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to upload audio");
                }
                return response.text();
            })
            .then(feedback => {
                console.log("Feedback received:", feedback);
                document.getElementById("feedbackText").innerText = feedback;

            })
            .catch(error => console.error('Error uploading file:', error));
        }

        const start = document.querySelector(".start");
        const startRecord = document.querySelector(".startRecord");
        const stopRecord = document.querySelector(".stopRecord");
        const back = document.querySelector(".back");

        start.addEventListener("click", () => {
            wordToTranslate.style.visibility = "visible";
            startLesson();
            document.getElementById("controls").style.display = "none";
            document.getElementById("translationSection").style.display = "block";
            instructionText.innerText = "Say the word in the selected language";
        });

        back.addEventListener("click", () => {
            stopLesson();
            document.getElementById("controls").style.display = "block";
            document.getElementById("translationSection").style.display = "none";
        });

        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            console.log("getUserMedia supported.");
            navigator.mediaDevices.getUserMedia({audio: true})
            .then((stream) => {
                const mediaRecorder = new MediaRecorder(stream);

                const audioContext = new AudioContext();
                const source = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();  // Assign to global analyser
                source.connect(analyser);

                analyser.fftSize = 512;  // Adjust for resolution
                analyser.smoothingTimeConstant = 0.8;

                audioLevelsData = new Float32Array(analyser.fftSize);  // Assign to global audioLevelsData

                let audioChunks = [];

                mediaRecorder.addEventListener("dataavailable", (event) => {
                    audioChunks.push(event.data);
                });

                mediaRecorder.addEventListener("stop", () => {
                    handleStop(audioChunks);
                });

                startRecord.addEventListener("click", () => {
                    audioChunks = [];
                    startRecording(mediaRecorder, startRecord);
                });

                stopRecord.addEventListener("click", () => {
                    stopRecording(mediaRecorder, startRecord);
                });
            });
        } else {
            console.log("getUserMedia not supported on your browser!");
        }
    </script>
</body>
</html>